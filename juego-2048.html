<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2048 - Version Inicial</title>
    <style>
        /* --- Estilos Generales --- */
        body {
            font-family: "Clear Sans", "Helvetica Neue", Arial, sans-serif;
            background-color: #faf8ef;
            color: #776e65;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 500px;
            text-align: center;
        }

        /* --- Cabecera --- */
        h1 {
            font-size: 80px;
            font-weight: bold;
            margin: 0;
            display: inline-block;
        }

        .scores-container {
            float: right;
            text-align: right;
        }

        .score-container, .best-container {
            position: relative;
            display: inline-block;
            background: #bbada0;
            padding: 15px 25px;
            font-size: 25px;
            height: 25px;
            line-height: 25px;
            font-weight: bold;
            border-radius: 3px;
            color: white;
            margin-top: 8px;
            text-align: center;
            min-width: 80px;
        }

        .score-container:after, .best-container:after {
            position: absolute;
            width: 100%;
            top: 10px;
            left: 0;
            text-transform: uppercase;
            font-size: 13px;
            line-height: 13px;
            text-align: center;
            color: #eee4da;
        }

        .score-container:after {
            content: "Puntuación";
        }

        .best-container:after {
            content: "Mejor";
        }

        .game-intro {
            margin: 20px 0;
            clear: both;
        }

        .restart-button {
            display: inline-block;
            background: #8f7a66;
            border-radius: 3px;
            padding: 0 20px;
            text-decoration: none;
            color: #f9f6f2;
            height: 40px;
            line-height: 42px;
            cursor: pointer;
            font-weight: bold;
            margin-left: 20px;
            border: none;
            font-size: 18px;
        }

        .restart-button:hover {
            background: #9f8b77;
        }

        /* --- Grid del Juego --- */
        .game-container {
            position: relative;
            background: #bbada0;
            border-radius: 6px;
            box-sizing: border-box;
            margin-top: 40px;
            /* El tamaño se establecerá dinámicamente con JavaScript */
        }

        .grid-container {
            position: absolute;
            z-index: 1;
        }

        .grid-row {
            display: flex;
            margin-bottom: 10px; /* GAP se establecerá con JS */
        }
        
        .grid-row:last-child {
            margin-bottom: 0;
        }

        .grid-cell {
            background: rgba(238, 228, 218, 0.35);
            border-radius: 3px;
            margin-right: 10px; /* GAP se establecerá con JS */
        }
        
        .grid-cell:last-child {
            margin-right: 0;
        }

        /* --- Fichas (Tiles) --- */
        .tile-container {
            position: absolute;
            z-index: 2;
        }

        .tile {
            position: absolute;
            box-sizing: border-box;
            background: #eee4da;
            border-radius: 3px;
            font-weight: bold;
            text-align: center;
            transition: all 0.15s ease-in-out;
            animation: appear 0.2s ease-in-out;
            /* El tamaño y la fuente se establecerán dinámicamente con JavaScript */
        }

        @keyframes appear {
            0% {
                opacity: 0;
                transform: scale(0);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .tile-merged {
            animation: merge 0.2s ease-in-out;
            z-index: 20;
        }

        @keyframes merge {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }

        /* Colores de las fichas */
        .tile-2 { background: #eee4da; color: #776e65; }
        .tile-4 { background: #ede0c8; color: #776e65; }
        .tile-8 { background: #f2b179; color: #f9f6f2; }
        .tile-16 { background: #f59563; color: #f9f6f2; }
        .tile-32 { background: #f67c5f; color: #f9f6f2; }
        .tile-64 { background: #f65e3b; color: #f9f6f2; }
        .tile-128 { background: #edcf72; color: #f9f6f2; font-size: 45px; }
        .tile-256 { background: #edcc61; color: #f9f6f2; font-size: 45px; }
        .tile-512 { background: #edc850; color: #f9f6f2; font-size: 45px; }
        .tile-1024 { background: #edc53f; color: #f9f6f2; font-size: 35px; }
        .tile-2048 { background: #edc22e; color: #f9f6f2; font-size: 35px; }

        /* --- Mensajes de Fin de Juego --- */
        .game-message {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(238, 228, 218, 0.73);
            z-index: 100;
            text-align: center;
            border-radius: 6px;
        }

        .game-message p {
            font-size: 60px;
            font-weight: bold;
            height: 60px;
            line-height: 60px;
            margin-top: 150px;
        }

        .game-message .lower {
            display: block;
            margin-top: 30px;
        }

        .game-message.game-won {
            background: rgba(237, 194, 46, 0.5);
            color: #f9f6f2;
        }

        .game-message.game-won, .game-message.game-over {
            display: block;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>2048</h1>
            <div class="scores-container">
                <div class="score-container">0</div>
                <div class="best-container">0</div>
            </div>
        </div>
        
        <div class="game-intro">
            <p class="game-intro">¡Une las fichas y llega al <strong>2048!</strong></p>
            <button class="restart-button">Nueva Partida</button>
        </div>

        <div class="game-container" tabindex="0">
            <div class="grid-container"></div>
            <div class="tile-container"></div>
        </div>

        <div class="game-message">
            <p></p>
            <div class="lower">
                <button class="restart-button">Intentar de nuevo</button>
            </div>
        </div>
    </div>

    <script>
        // --- Variables y Estado del Juego ---
        const GRID_SIZE = 4;
        const CELL_SIZE = 106.25;
        const CELL_GAP = 15;
        const CONTAINER_PADDING = 15;

        let board = [];
        let score = 0;
        let bestScore = 0;
        let hasWon = false;

        // --- Referencias al DOM ---
        const scoreContainer = document.querySelector('.score-container');
        const bestContainer = document.querySelector('.best-container');
        const tileContainer = document.querySelector('.tile-container');
        const gridContainer = document.querySelector('.grid-container');
        const gameContainer = document.querySelector('.game-container');
        const gameMessage = document.querySelector('.game-message');
        const restartButton = document.querySelectorAll('.restart-button');

        // --- Inicialización ---
        function init() {
            board = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill(0));
            score = 0;
            hasWon = false;
            updateScore();
            hideGameMessage();
            setupLayout();
            addNewTile();
            addNewTile();
            updateDisplay();
            gameContainer.focus(); // Asegura que el contenedor tenga el foco para el teclado
        }

        function setupLayout() {
            const totalSize = (GRID_SIZE * CELL_SIZE) + ((GRID_SIZE - 1) * CELL_GAP) + (2 * CONTAINER_PADDING);
            
            gameContainer.style.width = `${totalSize}px`;
            gameContainer.style.height = `${totalSize}px`;
            gameContainer.style.padding = `${CONTAINER_PADDING}px`;
            
            gridContainer.innerHTML = '';
            for (let r = 0; r < GRID_SIZE; r++) {
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.style.marginBottom = `${CELL_GAP}px`;
                for (let c = 0; c < GRID_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.style.width = `${CELL_SIZE}px`;
                    cell.style.height = `${CELL_SIZE}px`;
                    cell.style.marginRight = `${CELL_GAP}px`;
                    row.appendChild(cell);
                }
                gridContainer.appendChild(row);
            }
        }

        // --- Lógica Principal del Juego ---

        function addNewTile() {
            const emptyCells = [];
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    if (board[r][c] === 0) {
                        emptyCells.push({ r, c });
                    }
                }
            }
            if (emptyCells.length > 0) {
                const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                board[randomCell.r][randomCell.c] = Math.random() < 0.9 ? 2 : 4;
            }
        }

        function updateDisplay() {
            tileContainer.innerHTML = '';
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    if (board[r][c] !== 0) {
                        const tile = document.createElement('div');
                        const value = board[r][c];
                        tile.className = `tile tile-${value}`;
                        tile.textContent = value;

                        // Cálculo de posición dinámico
                        const left = c * (CELL_SIZE + CELL_GAP) + CONTAINER_PADDING;
                        const top = r * (CELL_SIZE + CELL_GAP) + CONTAINER_PADDING;
                        
                        tile.style.left = `${left}px`;
                        tile.style.top = `${top}px`;
                        tile.style.width = `${CELL_SIZE}px`;
                        tile.style.height = `${CELL_SIZE}px`;
                        tile.style.lineHeight = `${CELL_SIZE}px`;
                        tile.style.fontSize = value < 100 ? '55px' : (value < 1000 ? '45px' : '35px');

                        tileContainer.appendChild(tile);
                    }
                }
            }
        }

        function move(direction) {
            let moved = false;
            const newBoard = board.map(row => [...row]); // Copia profunda

            if (direction === 'ArrowLeft' || direction === 'ArrowRight') {
                for (let r = 0; r < GRID_SIZE; r++) {
                    // CORRECCIÓN: Crear una copia invertida en lugar de modificar el original
                    let row = newBoard[r];
                    if (direction === 'ArrowRight') {
                        row = [...row].reverse();
                    }
                    
                    const newRow = slideAndMerge(row);
                    
                    if (direction === 'ArrowRight') {
                        newRow.reverse();
                    }
                    
                    if (JSON.stringify(newRow) !== JSON.stringify(board[r])) {
                        moved = true;
                    }
                    newBoard[r] = newRow;
                }
            } else if (direction === 'ArrowUp' || direction === 'ArrowDown') {
                for (let c = 0; c < GRID_SIZE; c++) {
                    let column = [newBoard[0][c], newBoard[1][c], newBoard[2][c], newBoard[3][c]];
                    // CORRECCIÓN: Crear una copia invertida en lugar de modificar el original
                    if (direction === 'ArrowDown') {
                        column = [...column].reverse();
                    }

                    const newColumn = slideAndMerge(column);

                    if (direction === 'ArrowDown') {
                        newColumn.reverse();
                    }
                    
                    for (let r = 0; r < GRID_SIZE; r++) {
                        if (newColumn[r] !== board[r][c]) {
                            moved = true;
                        }
                        newBoard[r][c] = newColumn[r];
                    }
                }
            }

            if (moved) {
                board = newBoard;
                addNewTile();
                updateDisplay();
                updateScore();
                checkGameStatus();
            }
        }

        function slideAndMerge(line) {
            // 1. Deslizar (quitar ceros)
            let newLine = line.filter(cell => cell !== 0);
            
            // 2. Fusionar
            for (let i = 0; i < newLine.length - 1; i++) {
                if (newLine[i] === newLine[i + 1]) {
                    newLine[i] *= 2;
                    score += newLine[i];
                    newLine.splice(i + 1, 1);
                }
            }

            // 3. Rellenar con ceros
            while (newLine.length < GRID_SIZE) {
                newLine.push(0);
            }
            
            return newLine;
        }

        function checkGameStatus() {
            // Comprobar si se ha ganado
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    if (board[r][c] === 2048 && !hasWon) {
                        hasWon = true;
                        showGameMessage('¡Has Ganado!', 'game-won');
                        return;
                    }
                }
            }

            // Comprobar si hay movimientos posibles
            let hasEmptyCell = false;
            let hasPossibleMerge = false;

            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    if (board[r][c] === 0) {
                        hasEmptyCell = true;
                    }
                    // Comprobar con el de la derecha
                    if (c < GRID_SIZE - 1 && board[r][c] === board[r][c + 1]) {
                        hasPossibleMerge = true;
                    }
                    // Comprobar con el de abajo
                    if (r < GRID_SIZE - 1 && board[r][c] === board[r + 1][c]) {
                        hasPossibleMerge = true;
                    }
                }
            }

            if (!hasEmptyCell && !hasPossibleMerge) {
                showGameMessage('¡Game Over!', 'game-over');
            }
        }

        // --- Funciones de UI ---
        function updateScore() {
            scoreContainer.textContent = score;
            if (score > bestScore) {
                bestScore = score;
                bestContainer.textContent = bestScore;
                localStorage.setItem('bestScore', bestScore);
            }
        }

        function showGameMessage(text, className) {
            gameMessage.querySelector('p').textContent = text;
            gameMessage.classList.add(className);
        }

        function hideGameMessage() {
            gameMessage.classList.remove('game-won', 'game-over');
        }

        // --- Event Listeners ---
        document.addEventListener('keydown', (event) => {
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(event.key)) {
                event.preventDefault();
                move(event.key);
            }
        });

        restartButton.forEach(button => {
            button.addEventListener('click', init);
        });

        // --- Cargar mejor puntuación y empezar el juego ---
        window.onload = () => {
            const savedBestScore = localStorage.getItem('bestScore');
            if (savedBestScore) {
                bestScore = parseInt(savedBestScore);
                bestContainer.textContent = bestScore;
            }
            init();
        };
    </script>
</body>
</html>
