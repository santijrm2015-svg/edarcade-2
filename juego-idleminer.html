<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Miner - Versión Corregida</title>
    <style>
        /* --- ESTILOS CSS (Sin cambios) --- */
        :root {
            --bg-color: #2c2416;
            --panel-bg: #3e3426;
            --text-color: #f4e4c1;
            --gold-color: #ffd700;
            --button-bg: #6b5d4f;
            --button-hover-bg: #8b7d6f;
            --disabled-bg: #4a3c2e;
            --accent-color: #a0826d;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        #header { width: 100%; background-color: var(--panel-bg); padding: 20px; text-align: center; border-bottom: 3px solid var(--accent-color); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #header h1 { margin: 0; font-size: 2.5em; text-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        #gold-display { font-size: 1.8em; margin-top: 10px; color: var(--gold-color); font-weight: bold; }
        #game-container { display: flex; width: 100%; max-width: 1200px; flex-grow: 1; padding: 20px; gap: 20px; box-sizing: border-box; }
        #mine-panel { flex: 2; background-color: var(--panel-bg); border-radius: 10px; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        #shaft-info { margin-bottom: 20px; text-align: center; }
        #shaft-info h2 { margin: 0; font-size: 1.8em; color: var(--gold-color); }
        #mine-button { width: 200px; height: 200px; background-color: var(--button-bg); border: 5px solid var(--accent-color); border-radius: 50%; font-size: 1.5em; font-weight: bold; color: var(--text-color); cursor: pointer; transition: transform 0.1s, background-color 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.4); margin-bottom: 20px; }
        #mine-button:hover { background-color: var(--button-hover-bg); }
        #mine-button:active { transform: scale(0.95); }
        .progress-container { width: 100%; background-color: var(--disabled-bg); border-radius: 15px; overflow: hidden; margin-bottom: 20px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.4); }
        .progress-bar { height: 30px; width: 0%; background-color: var(--gold-color); transition: width 0.1s linear; text-align: center; line-height: 30px; font-weight: bold; }
        #upgrade-panel { flex: 1; background-color: var(--panel-bg); border-radius: 10px; padding: 20px; overflow-y: auto; }
        .upgrade-section { margin-bottom: 30px; }
        .upgrade-section h3 { border-bottom: 2px solid var(--accent-color); padding-bottom: 5px; margin-top: 0; }
        .upgrade-item { background-color: var(--button-bg); border: 2px solid var(--accent-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s, transform 0.1s; text-align: center; }
        .upgrade-item:hover:not(.disabled) { background-color: var(--button-hover-bg); transform: scale(1.02); }
        .upgrade-item.disabled { background-color: var(--disabled-bg); color: #999; cursor: not-allowed; border-color: #555; }
        .upgrade-item h4 { margin: 0 0 5px 0; }
        .upgrade-item p { margin: 0; font-size: 0.9em; color: var(--gold-color); }
        @media (max-width: 768px) { #game-container { flex-direction: column; } #header h1 { font-size: 2em; } #gold-display { font-size: 1.5em; } }
    </style>
</head>
<body>

    <div id="header">
        <h1>Idle Miner</h1>
        <div id="gold-display">Oro: 10</div>
    </div>

    <div id="game-container">
        <div id="mine-panel">
            <div id="shaft-info">
                <h2>Mina Superficial</h2>
                <p>Mineros: 0 (Nivel 1)</p>
                <p>Producción: 0 oro/s</p>
            </div>
            <button id="mine-button">MINAR</button>
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar">0%</div>
            </div>
            <div id="next-shaft-info"></div>
        </div>

        <div id="upgrade-panel">
            <div class="upgrade-section">
                <h3>Mejoras de Mina</h3>
                <div id="mine-upgrades"></div>
            </div>
            <div class="upgrade-section">
                <h3>Gerentes</h3>
                <div id="manager-upgrades"></div>
            </div>
        </div>
    </div>

    <script>
        // --- LÓGICA JAVASCRIPT ---
        const goldDisplay = document.getElementById('gold-display');
        const mineButton = document.getElementById('mine-button');
        const progressBar = document.getElementById('progress-bar');
        const shaftInfo = document.getElementById('shaft-info');
        const mineUpgradesContainer = document.getElementById('mine-upgrades');
        const managerUpgradesContainer = document.getElementById('manager-upgrades');
        const nextShaftInfo = document.getElementById('next-shaft-info');

        let gameState = {
            gold: 10,
            currentShaft: 0,
            lastTick: Date.now(),
            miners: { 0: 0 },
            minerLevels: { 0: 1 },
            managers: { doubleSpeed: false, superMiner: false }
        };

        const manualMineAmount = 1;
        let mineProgress = 0;

        const shafts = [
            { name: 'Mina Superficial', baseCost: 15, baseGoldPerSec: 1, unlockCost: 0 },
            { name: 'Mina de Hierro', baseCost: 250, baseGoldPerSec: 5, unlockCost: 1000 },
            { name: 'Mina de Oro', baseCost: 3000, baseGoldPerSec: 25, unlockCost: 15000 },
            { name: 'Mina de Diamantes', baseCost: 50000, baseGoldPerSec: 150, unlockCost: 250000 },
            { name: 'Mina de Esmeraldas', baseCost: 1000000, baseGoldPerSec: 1000, unlockCost: 5000000 }
        ];

        const managerData = [
            { id: 'doubleSpeed', name: 'Duplicador de Velocidad', cost: 500, description: '¡Todas las minas son 2x más rápidas!' },
            { id: 'superMiner', name: 'Súper Minero', cost: 10000, description: '¡Cada minero es 3x más eficiente!' }
        ];

        // --- FUNCIONES PRINCIPALES ---
        function loadGame() { const savedState = localStorage.getItem('idleMinerGameState'); if (savedState) { gameState = JSON.parse(savedState); } if (!gameState.miners) gameState.miners = {}; if (!gameState.minerLevels) gameState.minerLevels = {}; if (!gameState.managers) gameState.managers = {}; }
        function saveGame() { localStorage.setItem('idleMinerGameState', JSON.stringify(gameState)); }
        function formatNumber(num) { if (num < 1000) return num.toFixed(0); if (num < 1000000) return (num / 1000).toFixed(1) + 'k'; if (num < 1000000000) return (num / 1000000).toFixed(2) + 'M'; return (num / 1000000000).toFixed(2) + 'B'; }

        function getGoldPerSecond() {
            const shaft = shafts[gameState.currentShaft];
            const miners = gameState.miners[gameState.currentShaft] || 0;
            const level = gameState.minerLevels[gameState.currentShaft] || 1;
            let gps = miners * level * shaft.baseGoldPerSec;
            if (gameState.managers.superMiner) gps *= 3;
            if (gameState.managers.doubleSpeed) gps *= 2;
            return gps;
        }

        function update(delta) {
            const gps = getGoldPerSecond();
            gameState.gold += gps * (delta / 1000);
            mineProgress += gps * (delta / 1000);
            if (mineProgress > 1) mineProgress = 1;
            progressBar.style.width = `${mineProgress * 100}%`;
            progressBar.textContent = `${(mineProgress * 100).toFixed(1)}%`;
            render();
        }

        function render() {
            goldDisplay.textContent = `Oro: ${formatNumber(gameState.gold)}`;
            const shaft = shafts[gameState.currentShaft];
            const miners = gameState.miners[gameState.currentShaft] || 0;
            const level = gameState.minerLevels[gameState.currentShaft] || 1;
            shaftInfo.innerHTML = `<h2>${shaft.name}</h2><p>Mineros: ${miners} (Nivel ${level})</p><p>Producción: ${formatNumber(getGoldPerSecond())} oro/s</p>`;
            renderMineUpgrades();
            renderManagerUpgrades();
            renderNextShaftInfo();
        }
        
        // --- ACCIONES DEL JUGADOR (CON LA CORRECCIÓN APLICADA) ---

        function buyMiner() {
            const minerCount = gameState.miners[gameState.currentShaft] || 0;
            const shaft = shafts[gameState.currentShaft];
            const cost = Math.floor(shaft.baseCost * Math.pow(1.15, minerCount));
            
            if (gameState.gold >= cost) {
                gameState.gold -= cost; // <-- ¡AQUÍ SE RESTA EL ORO AL CONTRATAR!
                gameState.miners[gameState.currentShaft] = minerCount + 1;
                render();
            }
        }

        function upgradeMiner() {
            const minerLevel = gameState.minerLevels[gameState.currentShaft] || 1;
            const shaft = shafts[gameState.currentShaft];
            const cost = Math.floor(shaft.baseCost * 10 * Math.pow(1.5, minerLevel -1));

            if (gameState.gold >= cost) {
                gameState.gold -= cost; // <-- ¡AQUÍ SE RESTA EL ORO AL MEJORAR!
                gameState.minerLevels[gameState.currentShaft] = minerLevel + 1;
                render();
            }
        }

        function buyManager(managerId) {
            const manager = managerData.find(m => m.id === managerId);
            if (gameState.gold >= manager.cost && !gameState.managers[managerId]) {
                gameState.gold -= manager.cost; // <-- ¡AQUÍ SE RESTA EL ORO AL COMPRAR UN GERENTE!
                gameState.managers[managerId] = true;
                render();
            }
        }

        function renderMineUpgrades() {
            const minerCount = gameState.miners[gameState.currentShaft] || 0;
            const minerLevel = gameState.minerLevels[gameState.currentShaft] || 1;
            const shaft = shafts[gameState.currentShaft];
            const hireCost = Math.floor(shaft.baseCost * Math.pow(1.15, minerCount));
            const upgradeCost = Math.floor(shaft.baseCost * 10 * Math.pow(1.5, minerLevel -1));

            mineUpgradesContainer.innerHTML = `
                <div class="upgrade-item ${gameState.gold < hireCost ? 'disabled' : ''}" onclick="buyMiner()">
                    <h4>Contratar Minero</h4>
                    <p>Costo: ${formatNumber(hireCost)} oro</p>
                </div>
                <div class="upgrade-item ${gameState.gold < upgradeCost ? 'disabled' : ''}" onclick="upgradeMiner()">
                    <h4>Mejorar Minero (Nivel ${minerLevel + 1})</h4>
                    <p>Costo: ${formatNumber(upgradeCost)} oro</p>
                </div>
            `;
        }

        function renderManagerUpgrades() {
            managerUpgradesContainer.innerHTML = '';
            managerData.forEach(manager => {
                if (gameState.managers[manager.id]) return;
                const isDisabled = gameState.gold < manager.cost;
                const div = document.createElement('div');
                div.className = `upgrade-item ${isDisabled ? 'disabled' : ''}`;
                div.onclick = () => buyManager(manager.id);
                div.innerHTML = `<h4>${manager.name}</h4><p>${manager.description}</p><p>Costo: ${formatNumber(manager.cost)} oro</p>`;
                managerUpgradesContainer.appendChild(div);
            });
        }
        
        function unlockNextShaft() {
            if (gameState.currentShaft >= shafts.length - 1) return;
            const nextShaft = shafts[gameState.currentShaft + 1];
            if (gameState.gold >= nextShaft.unlockCost) {
                gameState.gold -= nextShaft.unlockCost; // <-- ¡Y AQUÍ TAMBIÉN SE RESTA EL ORO!
                gameState.currentShaft++;
                if (!gameState.miners[gameState.currentShaft]) { gameState.miners[gameState.currentShaft] = 0; gameState.minerLevels[gameState.currentShaft] = 1; }
                render();
            }
        }
        
        function renderNextShaftInfo() {
             if (gameState.currentShaft >= shafts.length - 1) { nextShaftInfo.innerHTML = `<p style="color: var(--gold-color);">¡Has alcanzado la mina más profunda!</p>`; return; }
            const nextShaft = shafts[gameState.currentShaft + 1];
            const canUnlock = gameState.gold >= nextShaft.unlockCost;
            nextShaftInfo.innerHTML = `<div class="upgrade-item ${!canUnlock ? 'disabled' : ''}" onclick="unlockNextShaft()"><h4>Desbloquear: ${nextShaft.name}</h4><p>Costo: ${formatNumber(nextShaft.unlockCost)} oro</p></div>`;
        }

        function manualMine() { gameState.gold += manualMineAmount; mineProgress = 0; render(); }

        // --- BUCLE DEL JUEGO Y EVENTOS ---
        function gameLoop() { const now = Date.now(); const delta = now - gameState.lastTick; update(delta); gameState.lastTick = now; requestAnimationFrame(gameLoop); }
        mineButton.addEventListener('click', manualMine);
        window.addEventListener('beforeunload', saveGame);
        loadGame();
        render();
        gameLoop();
        setInterval(saveGame, 30000);
    </script>
</body>
</html>
