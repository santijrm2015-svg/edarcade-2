<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Classic - Ed Arcade</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #0a0a0f; --primary-color: #00d4ff; --secondary-color: #ff006e; }
        body { background-color: var(--bg-color); color: #e0e0e0; font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .game-container { text-align: center; display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 500px; }
        .game-container h1 { font-family: 'Orbitron', sans-serif; font-size: 2.5rem; margin-bottom: 1rem; color: var(--primary-color); text-shadow: 0 0 10px var(--primary-color); }
        #gameCanvas { border: 2px solid var(--primary-color); border-radius: 10px; box-shadow: 0 0 20px rgba(0, 212, 255, 0.5); background-color: #111; max-width: 100%; height: auto; }
        .game-controls { margin-top: 1.5rem; }
        .game-controls p { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; }

        /* Controles Táctiles para Móvil */
        .touch-controls { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; }
        .d-pad { position: relative; width: 150px; height: 150px; }
        .d-pad button { position: absolute; width: 50px; height: 50px; background: rgba(0, 212, 255, 0.3); border: 2px solid var(--primary-color); border-radius: 10px; color: var(--primary-color); font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; }
        .d-pad button:active { background: rgba(0, 212, 255, 0.6); }
        .d-pad .up { top: 0; left: 50px; }
        .d-pad .down { bottom: 0; left: 50px; }
        .d-pad .left { top: 50px; left: 0; }
        .d-pad .right { top: 50px; right: 0; }

        @media (max-width: 768px) {
            .touch-controls { display: block; }
            .game-controls p { display: none; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Snake Classic</h1>
        <canvas id="gameCanvas" width="400" height="400"></canvas>
        <div class="game-controls"><p>Usa las flechas del teclado para jugar</p></div>
    </div>

    <!-- Controles Táctiles -->
    <div class="touch-controls">
        <div class="d-pad">
            <button class="up" data-direction="up">↑</button>
            <button class="down" data-direction="down">↓</button>
            <button class="left" data-direction="left">←</button>
            <button class="right" data-direction="right">→</button>
        </div>
    </div>

    <script>
    // ===================================================================
    // INICIO DEL CÓDIGO DEL JUEGO (ENVUELTO EN UN IIFE)
    // ===================================================================
    (function() {
        'use strict';

        // --- VARIABLES DEL JUEGO (YA NO SON GLOBALES) ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 20;
        const tileCount = canvas.width / gridSize;
        
        let snake = [{x: 10, y: 10}];
        let food = {};
        let dx = 0;
        let dy = 0;
        let score = 0;
        let gameRunning = true;
        let gameLoopTimeoutId = null; // Guardaremos el ID del setTimeout

        // --- FUNCIONES DEL JUEGO ---
        function randomFood() {
            food = {
                x: Math.floor(Math.random() * tileCount),
                y: Math.floor(Math.random() * tileCount)
            };
        }

        function gameLoop() {
            if (!gameRunning) return;
            
            clearCanvas();
            moveSnake();
            drawFood();
            drawSnake();
            checkGameOver();
            
            gameLoopTimeoutId = setTimeout(gameLoop, 100);
        }

        function clearCanvas() {
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function drawSnake() {
            ctx.fillStyle = '#00d4ff';
            snake.forEach(segment => {
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
            });
        }

        function moveSnake() {
            const head = {x: snake[0].x + dx, y: snake[0].y + dy};
            snake.unshift(head);

            if (head.x === food.x && head.y === food.y) {
                score += 10;
                randomFood();
            } else {
                snake.pop();
            }
        }

        function drawFood() {
            ctx.fillStyle = '#ff006e';
            ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize - 2, gridSize - 2);
        }

        function checkGameOver() {
            const head = snake[0];

            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
                gameOver();
            }

            for (let i = 1; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) {
                    gameOver();
                }
            }
        }

        function gameOver() {
            gameRunning = false;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.font = '50px Orbitron';
            ctx.textAlign = 'center';
            ctx.fillText('GAME OVER', canvas.width / 2, canvas.height / 2 - 30);
            ctx.font = '20px Orbitron';
            ctx.fillText(`Puntuación: ${score}`, canvas.width / 2, canvas.height / 2 + 20);
        }
        
        function changeDirection(direction) {
            if (!gameRunning) return;
            
            const goingUp = dy === -1;
            const goingDown = dy === 1;
            const goingRight = dx === 1;
            const goingLeft = dx === -1;

            if (direction === 'left' && !goingRight) { dx = -1; dy = 0; }
            if (direction === 'up' && !goingDown) { dx = 0; dy = -1; }
            if (direction === 'right' && !goingLeft) { dx = 1; dy = 0; }
            if (direction === 'down' && !goingUp) { dx = 0; dy = 1; }
        }

        // --- MANEJO DE EVENTOS (CON LIMPIEZA Y MEJORA) ---
        const keydownHandler = (e) => {
            // Usamos e.key que es más moderno que e.keyCode
            const keyMap = { 'ArrowLeft': 'left', 'ArrowUp': 'up', 'ArrowRight': 'right', 'ArrowDown': 'down' };
            
            // Mensaje de depuración para ver si se detecta la tecla
            console.log("Tecla presionada:", e.key);

            if (keyMap[e.key]) {
                changeDirection(keyMap[e.key]);
            }
        };

        const touchClickHandler = (button) => {
            changeDirection(button.dataset.direction);
        };

        // --- FUNCIÓN DE LIMPIEZA PROPIA DEL JUEGO ---
        window.stopGame = function() {
            console.log("Deteniendo Snake...");
            gameRunning = false;
            clearTimeout(gameLoopTimeoutId);
            
            document.removeEventListener('keydown', keydownHandler);
            document.querySelectorAll('.d-pad button').forEach(button => {
                button.removeEventListener('click', () => touchClickHandler(button));
                button.removeEventListener('touchstart', (e) => { e.preventDefault(); touchClickHandler(button); });
            });
        };

        // --- INICIALIZACIÓN DEL JUEGO ---
        document.addEventListener('keydown', keydownHandler);
        document.querySelectorAll('.d-pad button').forEach(button => {
            button.addEventListener('click', () => touchClickHandler(button));
            button.addEventListener('touchstart', (e) => { e.preventDefault(); touchClickHandler(button); });
        });

        randomFood();
        gameLoop();

    })(); // FIN DEL IIFE
    // ===================================================================

    </script>
</body>
</html>
